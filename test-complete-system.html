<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Sistema Lotus Completo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 { color: #333; text-align: center; margin-bottom: 30px; }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        .test-section h3 {
            color: #555;
            margin-top: 0;
        }
        button {
            background: #007bff;
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover { background: #0056b3; }
        .success { background: #28a745; }
        .danger { background: #dc3545; }
        .warning { background: #ffc107; color: #212529; }
        
        .log {
            background: #000;
            color: #00ff00;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 10px;
        }
        
        .form-data {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin: 10px 0;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-weight: bold;
        }
        .status.ok { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .status.error { background: #f8d7da; color: #721c24; border: 1px solid #f1aeb5; }
        .status.info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåü Teste Sistema Lotus Completo</h1>
        
        <div class="test-section">
            <h3>üìÑ 1. Teste de Gera√ß√£o de PDF</h3>
            <p>Testa a gera√ß√£o de PDF com dados simulados de uma proposta.</p>
            <button onclick="testPDFGeneration()">Testar PDF</button>
            <button onclick="testPDFBlob()">Testar PDF Blob</button>
            <div id="pdf-status" class="status info">Aguardando teste...</div>
        </div>
        
        <div class="test-section">
            <h3>üíæ 2. Teste de Salvamento no Servidor</h3>
            <p>Testa o salvamento do PDF e dados no servidor PHP.</p>
            <button onclick="testServerSave()">Testar Salvamento</button>
            <div id="server-status" class="status info">Aguardando teste...</div>
        </div>
        
        <div class="test-section">
            <h3>üì± 3. Teste de Integra√ß√£o WAHA</h3>
            <p>Testa o envio de mensagem via WhatsApp usando WAHA API.</p>
            <button onclick="testWAHA()">Testar WAHA</button>
            <button onclick="testWAHAConnection()">Testar Conex√£o</button>
            <div id="waha-status" class="status info">Aguardando teste...</div>
        </div>
        
        <div class="test-section">
            <h3>üîÑ 4. Teste Sistema Completo</h3>
            <p>Executa todo o fluxo: PDF ‚Üí Servidor ‚Üí WhatsApp</p>
            <button onclick="testCompleteSystem()" class="success">Executar Teste Completo</button>
            <div id="complete-status" class="status info">Aguardando teste...</div>
        </div>
        
        <div class="test-section">
            <h3>üìä Dados de Teste</h3>
            <div class="form-data" id="test-data">
                Dados ser√£o carregados durante os testes...
            </div>
        </div>
        
        <div class="test-section">
            <h3>üìã Log do Sistema</h3>
            <div class="log" id="system-log">Sistema iniciado...\n</div>
        </div>
    </div>

    <script>
        // Configura√ß√µes WAHA
        const WAHA_URL = 'https://waha.nexus02.com';
        const WAHA_API_KEY = '083D38CBCA7707EAAC23CFC1A6A9A26BA9F854FC81D66AA01C0A6BC0298182299BF6A16004384F4891454A69BB15641ECE3919597CA103B82BCFEF3BD24A7EAF';
        const WHATSAPP_PHONE = '+5561999911676';
        
        // Dados de teste
        const testFormData = {
            nome: 'Jo√£o Silva Santos',
            cpfCnpj: '123.456.789-00',
            rgInsEst: '1234567-8',
            orgaoExpedidor: 'SSP/DF',
            sexo: 'masculino',
            dataNascimento: '1985-05-15',
            naturalidade: 'Bras√≠lia',
            nacionalidade: 'Brasileira',
            telefoneCelular: '(61) 99999-0000',
            telefoneComercial: '(61) 3333-0000',
            profissao: 'Engenheiro',
            email: 'joao.silva@email.com',
            rendaMensal: '8500,00',
            logradouro: 'QS 01 Rua 100',
            numero: '123',
            complemento: 'Bloco A Apt 101',
            bairro: '√Åguas Claras',
            cidade: 'Bras√≠lia',
            uf: 'DF',
            cep: '71940-000',
            estadoCivil: 'casado',
            nomeConjuge: 'Maria Silva Santos',
            cpfConjuge: '987.654.321-00',
            rgConjuge: '8765432-1',
            orgaoExpedidorConjuge: 'SSP/DF',
            profissaoConjuge: 'M√©dica',
            empreendimento: 'haya',
            unidadeNumero: '1205',
            valorImovel: '350.000,00',
            valorEntrada: '50.000,00',
            valorFinanciar: '300.000,00',
            quantidadeDocumentos: 5,
            dataEnvio: new Date().toISOString(),
            timestamp: Date.now()
        };
        
        function log(message) {
            const logDiv = document.getElementById('system-log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function setStatus(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }
        
        function showTestData() {
            document.getElementById('test-data').innerHTML = 
                '<pre>' + JSON.stringify(testFormData, null, 2) + '</pre>';
        }
        
        async function testPDFGeneration() {
            log('üîÑ Iniciando teste de gera√ß√£o de PDF...');
            setStatus('pdf-status', 'Gerando PDF...', 'info');
            
            try {
                const propostaHTML = generatePropostaHTML(testFormData);
                log(`üìÑ HTML gerado: ${propostaHTML.length} caracteres`);
                
                if (propostaHTML.length < 100) {
                    throw new Error('HTML muito pequeno');
                }
                
                log('‚úÖ PDF HTML gerado com sucesso');
                setStatus('pdf-status', 'PDF HTML gerado com sucesso!', 'ok');
                
                // Abrir em nova janela para visualiza√ß√£o
                const newWindow = window.open('', '_blank');
                newWindow.document.write(propostaHTML);
                newWindow.document.close();
                
            } catch (error) {
                log(`‚ùå Erro ao gerar PDF: ${error.message}`);
                setStatus('pdf-status', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testPDFBlob() {
            log('üîÑ Iniciando teste de PDF Blob...');
            setStatus('pdf-status', 'Gerando PDF Blob...', 'info');
            
            try {
                const propostaHTML = generatePropostaHTML(testFormData);
                
                // Criar elemento tempor√°rio
                const element = document.createElement('div');
                element.innerHTML = propostaHTML;
                element.style.cssText = `
                    position: absolute;
                    left: -9999px;
                    top: 0;
                    width: 800px;
                    background: white;
                    font-family: Arial, sans-serif;
                    visibility: hidden;
                `;
                document.body.appendChild(element);
                
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: 'teste-proposta.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        allowTaint: true,
                        backgroundColor: '#ffffff'
                    },
                    jsPDF: { 
                        unit: 'mm', 
                        format: 'a4', 
                        orientation: 'portrait' 
                    }
                };
                
                const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
                document.body.removeChild(element);
                
                if (pdfBlob && pdfBlob.size > 0) {
                    log(`‚úÖ PDF Blob gerado: ${pdfBlob.size} bytes`);
                    setStatus('pdf-status', `PDF Blob gerado com sucesso! (${pdfBlob.size} bytes)`, 'ok');
                    
                    // Fazer download do PDF
                    const url = URL.createObjectURL(pdfBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'teste-proposta-lotus.pdf';
                    a.click();
                    URL.revokeObjectURL(url);
                } else {
                    throw new Error('PDF Blob vazio ou inv√°lido');
                }
                
            } catch (error) {
                log(`‚ùå Erro ao gerar PDF Blob: ${error.message}`);
                setStatus('pdf-status', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testServerSave() {
            log('üîÑ Testando salvamento no servidor...');
            setStatus('server-status', 'Salvando no servidor...', 'info');
            
            try {
                // Primeiro gerar o PDF
                const propostaHTML = generatePropostaHTML(testFormData);
                const element = document.createElement('div');
                element.innerHTML = propostaHTML;
                element.style.cssText = `position: absolute; left: -9999px; width: 800px; background: white;`;
                document.body.appendChild(element);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const opt = {
                    margin: [10, 10, 10, 10],
                    filename: 'teste-proposta.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, backgroundColor: '#ffffff' },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                const pdfBlob = await html2pdf().set(opt).from(element).outputPdf('blob');
                document.body.removeChild(element);
                
                // Converter para base64
                const base64PDF = await blobToBase64(pdfBlob);
                
                // Enviar para o servidor
                const payload = {
                    pdfBase64: base64PDF,
                    filename: `teste-proposta-${Date.now()}.pdf`,
                    clientData: testFormData
                };
                
                const response = await fetch('/save-pdf.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        log(`‚úÖ PDF salvo no servidor: ${result.numeroProsposta}`);
                        setStatus('server-status', `PDF salvo com sucesso! N¬∫ ${result.numeroProsposta}`, 'ok');
                    } else {
                        throw new Error(result.error || 'Erro desconhecido');
                    }
                } else {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Erro ao salvar no servidor: ${error.message}`);
                setStatus('server-status', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testWAHAConnection() {
            log('üîÑ Testando conex√£o com WAHA...');
            setStatus('waha-status', 'Testando conex√£o...', 'info');
            
            try {
                const response = await fetch(`${WAHA_URL}/api/sessions`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': WAHA_API_KEY,
                    }
                });
                
                if (response.ok) {
                    const sessions = await response.json();
                    log(`‚úÖ Conex√£o WAHA OK. Sess√µes: ${JSON.stringify(sessions)}`);
                    setStatus('waha-status', 'Conex√£o WAHA estabelecida com sucesso!', 'ok');
                } else {
                    throw new Error(`Erro HTTP: ${response.status}`);
                }
                
            } catch (error) {
                log(`‚ùå Erro na conex√£o WAHA: ${error.message}`);
                setStatus('waha-status', `Erro na conex√£o: ${error.message}`, 'error');
            }
        }
        
        async function testWAHA() {
            log('üîÑ Testando envio via WAHA...');
            setStatus('waha-status', 'Enviando mensagem...', 'info');
            
            try {
                const mensagem = `üåü *TESTE SISTEMA LOTUS* üåü\n\n` +
                    `üë§ *Cliente:* ${testFormData.nome}\n` +
                    `üì± *Telefone:* ${testFormData.telefoneCelular}\n` +
                    `üè¢ *Empreendimento:* HAYA\n` +
                    `üí∞ *Valor:* R$ ${testFormData.valorImovel}\n\n` +
                    `‚è∞ *Teste em:* ${new Date().toLocaleString('pt-BR')}\n` +
                    `‚úÖ *Sistema funcionando corretamente!*`;
                
                const response = await fetch(`${WAHA_URL}/api/sendText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': WAHA_API_KEY,
                    },
                    body: JSON.stringify({
                        session: 'default',
                        chatId: `${WHATSAPP_PHONE}@c.us`,
                        text: mensagem
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ Mensagem enviada via WAHA: ${JSON.stringify(result)}`);
                    setStatus('waha-status', 'Mensagem enviada com sucesso!', 'ok');
                } else {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }
                
            } catch (error) {
                log(`‚ùå Erro ao enviar via WAHA: ${error.message}`);
                setStatus('waha-status', `Erro: ${error.message}`, 'error');
            }
        }
        
        async function testCompleteSystem() {
            log('üöÄ Iniciando teste do sistema completo...');
            setStatus('complete-status', 'Executando teste completo...', 'info');
            
            try {
                // 1. Gerar PDF
                log('üìÑ Etapa 1: Gerando PDF...');
                const propostaHTML = generatePropostaHTML(testFormData);
                const element = document.createElement('div');
                element.innerHTML = propostaHTML;
                element.style.cssText = `position: absolute; left: -9999px; width: 800px; background: white;`;
                document.body.appendChild(element);
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const pdfBlob = await html2pdf().set({
                    margin: [10, 10, 10, 10],
                    filename: 'teste-completo.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, backgroundColor: '#ffffff' },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).from(element).outputPdf('blob');
                
                document.body.removeChild(element);
                log(`‚úÖ PDF gerado: ${pdfBlob.size} bytes`);
                
                // 2. Salvar no servidor
                log('üíæ Etapa 2: Salvando no servidor...');
                const base64PDF = await blobToBase64(pdfBlob);
                
                const serverResponse = await fetch('/save-pdf.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pdfBase64: base64PDF,
                        filename: `teste-completo-${Date.now()}.pdf`,
                        clientData: testFormData
                    })
                });
                
                if (!serverResponse.ok) throw new Error(`Erro no servidor: ${serverResponse.status}`);
                
                const serverResult = await serverResponse.json();
                if (!serverResult.success) throw new Error(serverResult.error);
                
                log(`‚úÖ PDF salvo: ${serverResult.numeroProsposta}`);
                
                // 3. Enviar via WhatsApp
                log('üì± Etapa 3: Enviando via WhatsApp...');
                const mensagem = `üåü *TESTE SISTEMA LOTUS COMPLETO* üåü\n\n` +
                    `üë§ *Cliente:* ${testFormData.nome}\n` +
                    `üìÑ *Proposta N¬∫:* ${serverResult.numeroProsposta}\n` +
                    `üí∞ *Valor:* R$ ${testFormData.valorImovel}\n` +
                    `‚è∞ *Processado em:* ${new Date().toLocaleString('pt-BR')}\n\n` +
                    `‚úÖ *SISTEMA FUNCIONANDO 100%!*\n` +
                    `üîÑ *Todas as etapas executadas com sucesso*`;
                
                const wahaResponse = await fetch(`${WAHA_URL}/api/sendText`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Api-Key': WAHA_API_KEY,
                    },
                    body: JSON.stringify({
                        session: 'default',
                        chatId: `${WHATSAPP_PHONE}@c.us`,
                        text: mensagem
                    })
                });
                
                if (!wahaResponse.ok) throw new Error(`Erro WAHA: ${wahaResponse.status}`);
                
                log('‚úÖ WhatsApp enviado com sucesso!');
                
                // Sucesso completo
                log('üéâ TESTE COMPLETO CONCLU√çDO COM SUCESSO!');
                setStatus('complete-status', 'Sistema funcionando perfeitamente! üéâ', 'ok');
                
                // Download do PDF de teste
                const url = URL.createObjectURL(pdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'teste-sistema-completo.pdf';
                a.click();
                URL.revokeObjectURL(url);
                
            } catch (error) {
                log(`‚ùå ERRO NO TESTE COMPLETO: ${error.message}`);
                setStatus('complete-status', `Erro: ${error.message}`, 'error');
            }
        }
        
        // Fun√ß√£o para converter blob para base64
        function blobToBase64(blob) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onloadend = () => {
                    const base64 = reader.result.split(',')[1];
                    resolve(base64);
                };
                reader.onerror = reject;
                reader.readAsDataURL(blob);
            });
        }
        
        // Fun√ß√£o simplificada de gera√ß√£o de HTML da proposta
        function generatePropostaHTML(formData) {
            const currentDate = new Date();
            const numeroProsposta = `LP${currentDate.getFullYear()}${String(currentDate.getMonth() + 1).padStart(2, '0')}${String(currentDate.getDate()).padStart(2, '0')}${String(currentDate.getHours()).padStart(2, '0')}${String(currentDate.getMinutes()).padStart(2, '0')}`;
            
            return `<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Proposta Lotus - ${formData.nome}</title>
    <style>
        body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; background: white; color: black; }
        .container { max-width: 800px; margin: 0 auto; border: 2px solid #FFC629; padding: 20px; }
        .header { text-align: center; background: #FFC629; padding: 20px; margin: -20px -20px 20px -20px; }
        h1 { margin: 0; color: #000; }
        .numero { background: #000; color: #FFC629; padding: 8px 15px; border-radius: 20px; display: inline-block; margin-top: 10px; }
        .section { margin: 20px 0; }
        .field { margin: 10px 0; display: flex; }
        .label { font-weight: bold; min-width: 150px; }
        .value { border-bottom: 1px solid #000; flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PROPOSTA DE COMPRA LOTUS</h1>
            <div class="numero">N¬∫ ${numeroProsposta}</div>
        </div>
        
        <div class="section">
            <div class="field"><span class="label">Nome:</span><span class="value">${formData.nome || ''}</span></div>
            <div class="field"><span class="label">CPF/CNPJ:</span><span class="value">${formData.cpfCnpj || ''}</span></div>
            <div class="field"><span class="label">Telefone:</span><span class="value">${formData.telefoneCelular || ''}</span></div>
            <div class="field"><span class="label">Email:</span><span class="value">${formData.email || ''}</span></div>
        </div>
        
        <div class="section">
            <div class="field"><span class="label">Empreendimento:</span><span class="value">${formData.empreendimento?.toUpperCase() || ''}</span></div>
            <div class="field"><span class="label">Unidade:</span><span class="value">${formData.unidadeNumero || ''}</span></div>
            <div class="field"><span class="label">Valor do Im√≥vel:</span><span class="value">R$ ${formData.valorImovel || ''}</span></div>
            <div class="field"><span class="label">Valor de Entrada:</span><span class="value">R$ ${formData.valorEntrada || ''}</span></div>
        </div>
        
        <div style="margin-top: 50px; text-align: center;">
            <p><strong>Bras√≠lia-DF, ${currentDate.toLocaleDateString('pt-BR')}</strong></p>
            <div style="margin-top: 50px; display: flex; justify-content: space-between;">
                <div style="text-align: center;">
                    <div style="border-top: 1px solid #000; width: 200px; margin: 50px 0 10px 0;"></div>
                    <span>CLIENTE</span>
                </div>
                <div style="text-align: center;">
                    <div style="border-top: 1px solid #000; width: 200px; margin: 50px 0 10px 0;"></div>
                    <span>LOTUS CIDADE</span>
                </div>
            </div>
        </div>
    </div>
</body>
</html>`;
        }
        
        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            log('Sistema de teste iniciado');
            showTestData();
        });
    </script>
</body>
</html>